# Sales Job ‚Äî Python Flask + API Integration + Avro Conversion

## –û–ø–∏—Å –ø—Ä–æ–µ–∫—Ç—É
–ü—Ä–æ—î–∫—Ç —Ä–µ–∞–ª—ñ–∑—É—î **–¥–≤—ñ ETL-–¥–∂–æ–±–∏**:

1. **–ü–µ—Ä—à–∞ –¥–∂–æ–±–∞ (–ø–æ—Ä—Ç 8081)** ‚Äî –æ—Ç—Ä–∏–º—É—î –¥–∞–Ω—ñ –ø—Ä–æ–¥–∞–∂—ñ–≤ –∑ REST API  
   —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î —ó—Ö —É **raw-–¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é** —É –≤–∏–≥–ª—è–¥—ñ –æ–¥–Ω–æ–≥–æ JSON-—Ñ–∞–π–ª—É.
2. **–î—Ä—É–≥–∞ –¥–∂–æ–±–∞ (–ø–æ—Ä—Ç 8082)** ‚Äî –∑—á–∏—Ç—É—î JSON-—Ñ–∞–π–ª–∏ –∑ `raw`  
   —Ç–∞ –ø–µ—Ä–µ—Ç–≤–æ—Ä—é—î —ó—Ö —É —Ñ–æ—Ä–º–∞—Ç **Avro** —É `stg`-–¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é.
   
–ó–∞–¥–∞—á–∞ –≤–∫–ª—é—á–∞—î:
- –í–∏–∫–ª–∏–∫ –∑–æ–≤–Ω—ñ—à–Ω—å–æ–≥–æ API `https://fake-api-vycpfa6oca-uc.a.run.app/`
- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω (—É –∑–º—ñ–Ω–Ω—ñ–π —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ `AUTH_TOKEN`)
- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è Flask-—Å–µ—Ä–≤–µ—Ä–∞, —è–∫–∏–π –∑–∞–ø—É—Å–∫–∞—î –ø—Ä–æ—Ü–µ—Å –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —á–µ—Ä–µ–∑ POST-–∑–∞–ø–∏—Ç
- –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –æ—Ç—Ä–∏–º–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö —É Windows-—à–ª—è—Ö–∏ (`C:\...`) –∞–±–æ WSL-—à–ª—è—Ö–∏ (`/mnt/c/...`)
- –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è Json —Ñ–∞–π–ª—ñ–≤ —É AVRO
- –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å: –ø–µ—Ä–µ–¥ –Ω–æ–≤–∏–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è–º –≤–º—ñ—Å—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ–π –æ—á–∏—â—É—î—Ç—å—Å—è
- –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è –≤—Å—ñ—Ö –æ—Å–Ω–æ–≤–Ω–∏—Ö –º–æ–¥—É–ª—ñ–≤   

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç—É

```
sales_job/
‚îú‚îÄ‚îÄ main.py              # Flask –≤–µ–±-—Å–µ—Ä–≤–µ—Ä 1-—ó –¥–∂–æ–±–∏ (JSON - raw)
‚îú‚îÄ‚îÄ sales_api.py         # –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ–¥–∞–∂—ñ–≤ —ñ–∑ API
‚îú‚îÄ‚îÄ local_disk.py        # –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON –Ω–∞ –¥–∏—Å–∫
‚îú‚îÄ‚îÄ main_avro.py         # Flask —Å–µ—Ä–≤–µ—Ä 2-—ó –¥–∂–æ–±–∏ (JSON - Avro)
‚îú‚îÄ‚îÄ avro_writer.py       # –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è JSON —É Avro
‚îú‚îÄ‚îÄ check_jobs.py        # –°–∫—Ä–∏–ø—Ç —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–æ—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –¥–≤–æ—Ö –¥–∂–æ–±
‚îú‚îÄ‚îÄ test_main.py         # –¢–µ—Å—Ç–∏ –¥–ª—è Flask API 1-—ó –¥–∂–æ–±–∏
‚îú‚îÄ‚îÄ test_sales_api.py    # –¢–µ—Å—Ç–∏ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó get_sales()
‚îú‚îÄ‚îÄ test_local_disk.py   # –¢–µ—Å—Ç–∏ –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON
‚îú‚îÄ‚îÄ test_main_avro.py    # –¢–µ—Å—Ç–∏ –¥–ª—è Flask API 2-—ó –¥–∂–æ–±–∏
‚îú‚îÄ‚îÄ test_avro_writer.py  # –¢–µ—Å—Ç–∏ –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó JSON ‚Üí Avro
‚îî‚îÄ‚îÄ requirements.txt     # –°–ø–∏—Å–æ–∫ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π (Flask, requests, fastavro, pytest)
```

---

## –õ–æ–≥—ñ–∫–∞ —Ä–æ–±–æ—Ç–∏

### üîπ –ü–µ—Ä—à–∞ –¥–∂–æ–±–∞: –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON

1. **Flask —Å–µ—Ä–≤–µ—Ä (`main.py`)** –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—Ç—É `8081`.
2. –ü—Ä–∏–π–º–∞—î POST `/` —ñ–∑ JSON:
   ```json
   {
     "date": "2022-08-09",
     "raw_dir": "/mnt/c/my_homework/lec02/raw/sales/2022-08-09"
   }
   ```
3. –í–∏–∫–æ–Ω—É—î:
   - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω —É –∑–º—ñ–Ω–Ω—ñ–π —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ `AUTH_TOKEN`;
   - –≤–∏–∫–ª–∏–∫ API —á–µ—Ä–µ–∑ `sales_api.py`;
   - –æ—á–∏—â–µ–Ω–Ω—è `raw_dir` —Ç–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ —á–µ—Ä–µ–∑ `local_disk.py`;
   - –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è `HTTP 201` —É —Ä–∞–∑—ñ —É—Å–ø—ñ—Ö—É.
4. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   ```
   /mnt/c/my_homework/lec02/raw/sales/2022-08-09/sales_2022-08-09.json
   ```

---

### üîπ –î—Ä—É–≥–∞ –¥–∂–æ–±–∞: –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—è JSON - Avro

1. **Flask —Å–µ—Ä–≤–µ—Ä (`main_avro.py`)** –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ä—Ç—É `8082`.
2. –ü—Ä–∏–π–º–∞—î POST `/` —ñ–∑ JSON:
   ```json
   {
     "raw_dir": "/mnt/c/my_homework/lec02/raw/sales/2022-08-09",
     "stg_dir": "/mnt/c/my_homework/lec02/stg/sales/2022-08-09"
   }
   ```
3. –î–∂–æ–±–∞:
   - —á–∏—Ç–∞—î –≤—Å—ñ `.json` —Ñ–∞–π–ª–∏ –≤ `raw_dir`;
   - –ø–µ—Ä–µ–≤—ñ—Ä—è—î —É–∑–≥–æ–¥–∂–µ–Ω—ñ—Å—Ç—å –¥–∞—Ç–∏ —É –ø–æ–ª—ñ `purchase_date`;
   - –æ—á–∏—â—É—î `stg_dir`;
   - —Å—Ç–≤–æ—Ä—é—î —Ñ–∞–π–ª `sales_<date>.avro` —á–µ—Ä–µ–∑ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É **fastavro**;
   - –ø–æ–≤–µ—Ä—Ç–∞—î HTTP 201 —ñ–∑ —à–ª—è—Ö–æ–º –¥–æ —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ —Ñ–∞–π–ª—É.

**–°—Ö–µ–º–∞ Avro:**
```json
{
  "type": "record",
  "name": "Sale",
  "namespace": "sales.etl",
  "fields": [
    {"name": "client", "type": "string"},
    {"name": "purchase_date", "type": "string"},
    {"name": "product", "type": "string"},
    {"name": "price", "type": "int"}
  ]
}
```

---

## –Ø–∫ –ø—Ä–∞—Ü—é—é—Ç—å –º–æ–¥—É–ª—ñ

### `sales_api.py`
–û—Ç—Ä–∏–º—É—î —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –¥–∞–Ω–∏—Ö —ñ–∑ API (`requests`, —Ç–æ–∫–µ–Ω —É –∑–∞–≥–æ–ª–æ–≤–∫—É `Authorization`).

### `local_disk.py`
–û—á–∏—â—É—î —Ü—ñ–ª—å–æ–≤—É –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é —Ç–∞ —Å—Ç–≤–æ—Ä—é—î JSON-—Ñ–∞–π–ª  
`sales_<date>.json` —É –≤–∫–∞–∑–∞–Ω–æ–º—É `raw_dir`.

### `main.py`
Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –ø–µ—Ä—à–æ—ó –¥–∂–æ–±–∏ (–ø–æ—Ä—Ç `8081`).  
–í–∞–ª—ñ–¥—É—î –≤—Ö—ñ–¥–Ω—ñ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏, –∫–µ—Ä—É—î –ø—Ä–æ—Ü–µ—Å–æ–º –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.

### `avro_writer.py`
- –ó—á–∏—Ç—É—î –≤—Å—ñ JSON-—Ñ–∞–π–ª–∏ –∑ `raw_dir`;
- –°—Ç–≤–æ—Ä—é—î `.avro` —Ñ–∞–π–ª —É `stg_dir`;
- –Ü–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ –æ—á–∏—â—É—î `stg_dir` –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å–æ–º;
- –ü—ñ–¥—Ç—Ä–∏–º—É—î Windows —ñ WSL-—à–ª—è—Ö–∏;
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `fastavro` –¥–ª—è —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó.

### `main_avro.py`
Flask-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –¥—Ä—É–≥–æ—ó –¥–∂–æ–±–∏ (–ø–æ—Ä—Ç `8082`).  
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î `avro_writer.write_avro_from_raw()`.

### `check_jobs.py`
–Ü–Ω—Ç–µ–≥—Ä–∞—Ü—ñ–π–Ω–∏–π —Å–∫—Ä–∏–ø—Ç:
1. –≤–∏–∫–ª–∏–∫–∞—î –ø–µ—Ä—à—É –¥–∂–æ–±—É - —Å—Ç–≤–æ—Ä—é—î JSON;
2. –≤–∏–∫–ª–∏–∫–∞—î –¥—Ä—É–≥—É - —Å—Ç–≤–æ—Ä—é—î Avro;
3. –ø–µ—Ä–µ–≤—ñ—Ä—è—î, —á–∏ —ñ—Å–Ω—É—î `.avro` —É `stg_dir`.

---

## –¢–µ—Å—Ç—É–≤–∞–Ω–Ω—è

–¢–µ—Å—Ç–∏ –ø–æ–∫—Ä–∏–≤–∞—é—Ç—å:
- **1-—à—É –¥–∂–æ–±—É:** Flask API, –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è JSON, API-–ª–æ–≥—ñ–∫—É, —ñ–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ñ—Å—Ç—å.
- **2-–≥—É –¥–∂–æ–±—É:** Flask API (8082), —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è `.avro` —Ñ–∞–π–ª—É, –≤–∞–ª—ñ–¥–∞—Ü—ñ—é –¥–∞—Ç.

–ó–∞–ø—É—Å–∫ —É—Å—ñ—Ö —Ç–µ—Å—Ç—ñ–≤:
```bash
pytest -q
```

–û—á—ñ–∫—É–≤–∞–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
```
..........                                                                                   [100%]
8 passed in 3.1s
```

---

## –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—è –∑ –∑–∞–ø—É—Å–∫—É —É WSL

### 1Ô∏è –ü–µ—Ä–µ–π—Ç–∏ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä—ñ—é –ø—Ä–æ—î–∫—Ç—É
```bash
cd /mnt/c/my_homework/lec02/sales_job
```

### 2Ô∏è –ê–∫—Ç–∏–≤—É–≤–∞—Ç–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ
```bash
source .venv/bin/activate
```

### 3Ô∏è –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ –∑–∞–ª–µ–∂–Ω–æ—Å—Ç—ñ
```bash
pip install -r requirements.txt
```

### 4Ô∏è –í—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —Ç–æ–∫–µ–Ω
```bash
export AUTH_TOKEN="SECRET_TOKEN"
```

### 5Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –ø–µ—Ä—à—É –¥–∂–æ–±—É (8081)
```bash
python main.py
```

### 6Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç–∏ –¥—Ä—É–≥—É –¥–∂–æ–±—É (8082) –≤ —ñ–Ω—à—ñ–π –≤–∫–ª–∞–¥—Ü—ñ
```bash
python main_avro.py
```

### 7Ô∏è –í–∏–∫–æ–Ω–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É
(—É —Ç—Ä–µ—Ç—ñ–π –≤–∫–ª–∞–¥—Ü—ñ)
```bash
python check_jobs.py
```
–û—á—ñ–∫—É–≤–∞–Ω–æ:
```
[1/3] Calling first job ... -> 201
[2/3] Calling second job ... -> 201
[3/3] OK: /mnt/c/my_homework/lec02/stg/sales/2022-08-09/sales_2022-08-09.avro
```

---

## –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞

–î–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–∏ –ø–µ—Ä–µ–≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–ª–µ–∂–Ω–æ—Å—Ç–µ–π:

```bash
cd /mnt/c/my_homework/lec02/sales_job
source .venv/bin/activate
pip install -r requirements.txt --upgrade
```

–£ —Å–∫–ª–∞–¥—ñ:
- **Flask 3.1.2** ‚Äî –≤–µ–±-—Ñ—Ä–µ–π–º–≤–æ—Ä–∫ –¥–ª—è API;
- **Requests 2.32.5** ‚Äî –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö —ñ–∑ REST API;
- **Pytest 8.4.2** ‚Äî —Ç–µ—Å—Ç—É–≤–∞–Ω–Ω—è;
- **fastavro 1.9.7** ‚Äî —Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Avro –¥–ª—è –¥—Ä—É–≥–æ—ó –¥–∂–æ–±–∏.


## –ê–≤—Ç–æ—Ä
**Denis Shcherbyna**  
WSL —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ: Ubuntu on Windows 11  
–ü—Ä–æ—î–∫—Ç –¥–ª—è –Ω–∞–≤—á–∞–ª—å–Ω–æ–≥–æ –∫—É—Ä—Å—É **Data Engineering / Python –¥–ª—è Data Engineering /**